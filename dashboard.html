<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEA MASTER - Layer Feedback Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
        }

        /* [Keep all your existing CSS styles - they remain unchanged] */
        /* ... */

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .view-mode .data-item {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                max-height: 400px;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            input[type="text"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä SEA MASTER - Layer Feedback Tracker</h1>
            <img src="https://th.bing.com/th/id/R.e7b9c51d08d56a5b39f7c8a8d4c82d1c?rik=sf6WpzmhZ89Q6A&riu=http%3a%2f%2fforum.mappls.com%2fuploads%2fdefault%2foriginal%2f1X%2f86b6560c8d8137741b6b955fd9838a03e9af5308.png&ehk=tdH5AJ44f95OX4S6rI8OEArNM0rbcG0NiEAZLL91exk%3d&risl=&pid=ImgRaw&r=0" 
                 alt="Mappls MapmyIndia Logo"/>
            <div class="controls">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".json,.csv">
                    <label for="fileInput" class="file-input-label">üìÅ Upload JSON/CSV</label>
                </div>
                <input type="text" id="searchInput" placeholder="üîç Search data...">
                <button onclick="addNewItem()" class="btn-success admin-only">‚ûï Add New Item</button>
                <button onclick="exportData()" class="btn-primary">üíæ Export JSON</button>
                <button onclick="loadDataFromPath()" class="btn-primary">üîÑ Reload Data</button>
                <button onclick="toggleFilterPanel()" class="btn-primary">üîç Show Filters</button>
            </div>
            <div style="margin-top: 15px; font-size: 14px; color: #666;">
                <span id="autoLoadStatus">Data source: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;" id="dataSourceDisplay">/api/data</code></span>
                <span id="lastUpdate" style="margin-left: 20px;"></span>
                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
                    <strong>‚úÖ Auto-Save Enabled:</strong> Changes saved to Cyclic.sh
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 5px; color: #1565c0;">
                    <strong>üåê User: </strong>
                    <span id="currentUserDisplay">Loading...</span>
                    <button onclick="adminLogin()" id="adminLoginBtn" class="btn-primary" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">Admin Login</button>
                    <button onclick="adminLogout()" id="adminLogoutBtn" class="btn-danger" style="margin-left: 10px; padding: 5px 10px; font-size: 12px; display: none;">Logout</button>
                </div>
            </div>
        </div>

        <div class="filter-panel" id="filterPanel" style="display: none;">
            <h3>üîç Filter Data</h3>
            <div class="filter-controls" id="filterControls"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="applyFilters()" class="btn-primary">Apply Filters</button>
                <button onclick="resetFilters()" class="btn-danger">Reset Filters</button>
                <button onclick="toggleFilterPanel()" class="btn-primary">Hide Filters</button>
            </div>
        </div>
        
        <div class="status-chart" id="statusChart" style="display: none;">
            <div class="chart-title">üìä Status Distribution</div>
            <div class="chart-container" id="chartContainer"></div>
        </div>

        <div class="table-container">
            <div id="tableContainer"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">View/Edit Item</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div id="notification"></div>

    <script>
        // Cyclic.sh Configuration
        const IS_DEVELOPMENT = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE = IS_DEVELOPMENT ? 'http://localhost:3000/api' : '/api';

        const CONFIG = {
            dataPath: `${API_BASE}/data`,
            autoReload: true,
            reloadInterval: 10000, // 10 seconds
            autoSave: true,
            saveEndpoint: `${API_BASE}/save`,
            adminPassword: 'change_this_for_production',
            editableByAll: ['Production_Team_Remark', 'Status'],
            statusColors: {
                'Pending': 'status-pending',
                'Completed': 'status-completed',
                'Rejected': 'status-rejected',
                'In Progress': 'status-inprogress'
            }
        };

        // Application State
        let jsonData = [];
        let filteredData = [];
        let editingIndex = -1;
        let currentViewMode = 'view';
        let activeFilters = {};
        let currentSearchTerm = '';
        let isUserInteracting = false;
        let lastDataUpdate = null;
        let isAdmin = false;
        let currentUser = 'Guest';
        let reloadInterval = null;

        // DOM Elements
        const elements = {
            dataSourceDisplay: document.getElementById('dataSourceDisplay'),
            lastUpdate: document.getElementById('lastUpdate'),
            currentUserDisplay: document.getElementById('currentUserDisplay'),
            adminLoginBtn: document.getElementById('adminLoginBtn'),
            adminLogoutBtn: document.getElementById('adminLogoutBtn'),
            filterPanel: document.getElementById('filterPanel'),
            filterControls: document.getElementById('filterControls'),
            statusChart: document.getElementById('statusChart'),
            chartContainer: document.getElementById('chartContainer'),
            tableContainer: document.getElementById('tableContainer'),
            searchInput: document.getElementById('searchInput'),
            fileInput: document.getElementById('fileInput'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            modalFooter: document.getElementById('modalFooter'),
            notification: document.getElementById('notification')
        };

        // Core Functions
        async function loadDataFromPath() {
            if (isUserInteracting || elements.modal.style.display === 'block') return;
            
            try {
                const response = await fetch(`${CONFIG.dataPath}?t=${Date.now()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                const newDataStr = JSON.stringify(data);
                const oldDataStr = JSON.stringify(jsonData);
                
                if (newDataStr !== oldDataStr) {
                    jsonData = Array.isArray(data) ? data : [data];
                    lastDataUpdate = new Date();
                    applySearchAndFilters();
                    
                    // Update UI
                    const now = new Date();
                    elements.lastUpdate.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                    if (jsonData.length > 0 && elements.filterControls.children.length === 0) {
                        initFilterPanel();
                    }
                }
            } catch (error) {
                console.error('Data load error:', error);
                if (!jsonData.length) {
                    showNotification(`Error loading data from ${CONFIG.dataPath}`, 'error');
                }
            }
        }

        async function saveToFile() {
            try {
                const response = await fetch(CONFIG.saveEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: jsonData,
                        user: currentUser,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Save failed');
                }
                console.log('Changes saved to Cyclic.sh');
                return true;
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Failed to save changes: ' + error.message, 'error');
                return false;
            }
        }

        // User Management
        function getUserIdentifier() {
            const savedUserId = localStorage.getItem('seaMasterUserId');
            if (savedUserId) {
                currentUser = savedUserId;
                updateUserDisplay();
                return currentUser;
            }
            
            let userId = prompt('Please enter your name:', 'Team Member');
            if (!userId || userId.trim() === '') userId = 'Guest';
            userId = userId.trim();
            
            localStorage.setItem('seaMasterUserId', userId);
            currentUser = userId;
            updateUserDisplay();
            showNotification(`Welcome ${currentUser}! Your edits will be tracked.`);
            return userId;
        }

        function updateUserDisplay() {
            elements.currentUserDisplay.textContent = currentUser;
        }

        // Admin Functions
        function checkAdminStatus() {
            isAdmin = localStorage.getItem('seaMasterAdmin') === 'true';
            updateAdminUI();
        }

        function adminLogin() {
            const password = prompt('Enter admin password:');
            if (password === CONFIG.adminPassword) {
                isAdmin = true;
                localStorage.setItem('seaMasterAdmin', 'true');
                updateAdminUI();
                showNotification('Admin privileges enabled');
            } else {
                showNotification('Invalid password', 'error');
            }
        }

        function adminLogout() {
            isAdmin = false;
            localStorage.removeItem('seaMasterAdmin');
            updateAdminUI();
            showNotification('Admin privileges disabled');
        }

        function updateAdminUI() {
            elements.adminLoginBtn.style.display = isAdmin ? 'none' : 'inline-block';
            elements.adminLogoutBtn.style.display = isAdmin ? 'inline-block' : 'none';
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? 'inline-block' : 'none';
            });
        }

        // Data Filtering
        function initFilterPanel() {
            if (jsonData.length === 0) return;
            
            elements.filterControls.innerHTML = '';
            const sampleItem = jsonData[0];
            
            Object.keys(sampleItem).forEach(key => {
                if (key.toLowerCase().includes('id')) return;
                
                const filterGroup = document.createElement('div');
                filterGroup.className = 'filter-group';
                
                const label = document.createElement('label');
                label.htmlFor = `filter-${key}`;
                label.textContent = key;
                
                const uniqueValues = [...new Set(jsonData.map(item => item[key]))]
                    .filter(v => v !== undefined && v !== null)
                    .sort();
                
                let control;
                
                if (uniqueValues.length <= 10) {
                    control = document.createElement('select');
                    control.id = `filter-${key}`;
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- All --';
                    control.appendChild(defaultOption);
                    
                    uniqueValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        control.appendChild(option);
                    });
                } else {
                    control = document.createElement('input');
                    control.type = 'text';
                    control.id = `filter-${key}`;
                    control.placeholder = `Filter ${key}`;
                }
                
                control.onchange = control.oninput = () => updateFilter(key, control.value);
                filterGroup.appendChild(label);
                filterGroup.appendChild(control);
                elements.filterControls.appendChild(filterGroup);
            });
            
            if (loadFiltersFromStorage()) {
                applySavedFiltersToUI();
                applySearchAndFilters();
            }
            
            elements.filterPanel.style.display = 'block';
        }

        function applySavedFiltersToUI() {
            Object.entries(activeFilters).forEach(([key, value]) => {
                const filterElement = document.getElementById(`filter-${key}`);
                if (filterElement) filterElement.value = value;
            });
        }

        function updateFilter(key, value) {
            isUserInteracting = true;
            if (value === '') delete activeFilters[key];
            else activeFilters[key] = value;
            setTimeout(() => isUserInteracting = false, 1000);
        }

        function applySearchAndFilters() {
            let tempData = [...jsonData];
            
            // Apply filters
            if (Object.keys(activeFilters).length > 0) {
                tempData = tempData.filter(item => {
                    return Object.entries(activeFilters).every(([key, value]) => {
                        const itemValue = String(item[key] || '').toLowerCase();
                        const filterValue = String(value).toLowerCase();
                        return itemValue.includes(filterValue);
                    });
                });
            }
            
            // Apply search
            if (currentSearchTerm) {
                tempData = tempData.filter(item => {
                    return Object.values(item).some(value => 
                        String(value).toLowerCase().includes(currentSearchTerm)
                    );
                });
            }
            
            filteredData = tempData;
            renderTable();
            updateStatusChart();
        }

        function applyFilters() {
            applySearchAndFilters();
            saveFiltersToStorage();
            showNotification(`Applied filters (${filteredData.length} items)`);
        }

        function resetFilters() {
            activeFilters = {};
            currentSearchTerm = '';
            localStorage.removeItem('seaMasterFilters');
            localStorage.removeItem('seaMasterSearch');
            
            document.querySelectorAll('.filter-panel input, .filter-panel select').forEach(input => {
                input.value = '';
            });
            
            elements.searchInput.value = '';
            filteredData = [...jsonData];
            renderDashboard();
            showNotification('Filters reset');
        }

        // Data Display
        function renderDashboard() {
            renderTable();
            updateStatusChart();
        }

        function updateStatusChart(statusCounts = null) {
            if (!statusCounts && jsonData.length > 0 && 'Status' in jsonData[0]) {
                statusCounts = {};
                jsonData.forEach(item => {
                    const status = item.Status || 'Unknown';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
            }
            
            if (!statusCounts || Object.keys(statusCounts).length === 0) {
                elements.statusChart.style.display = 'none';
                return;
            }
            
            elements.statusChart.style.display = 'block';
            const maxCount = Math.max(...Object.values(statusCounts));
            
            elements.chartContainer.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
                const percentage = (count / maxCount) * 100;
                const statusClass = status.toLowerCase().replace(/\s+/g, '');
                return `
                    <div class="chart-bar">
                        <div class="bar status-${statusClass}" 
                             style="height: ${Math.max(percentage, 10)}%;"
                             title="${status}: ${count} items">
                            <div class="bar-value">${count}</div>
                        </div>
                        <div class="bar-label">${status}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTable() {
            if (filteredData.length === 0) {
                elements.tableContainer.innerHTML = `
                    <div class="empty-state">
                        <h2>No data to display</h2>
                        <p>Upload a file or check your filters</p>
                    </div>
                `;
                return;
            }

            const keys = Object.keys(filteredData[0]);
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            ${keys.map(key => `<th>${key}</th>`).join('')}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map((item, index) => {
                            const originalIndex = jsonData.indexOf(item);
                            const hasEditableFields = CONFIG.editableByAll.some(field => field in item);
                            
                            return `
                                <tr onclick="viewItem(${originalIndex})" style="cursor: pointer;">
                                    ${keys.map(key => {
                                        const value = item[key] || '';
                                        let displayValue;
                                        
                                        if (key === 'Status') {
                                            displayValue = formatStatus(value);
                                        } else {
                                            displayValue = String(value).length > 50 ? 
                                                String(value).substring(0, 50) + '...' : value;
                                            displayValue = makeLinksClickable(displayValue);
                                        }
                                        
                                        return `<td title="${String(value).replace(/"/g, '&quot;')}">${displayValue}</td>`;
                                    }).join('')}
                                    <td onclick="event.stopPropagation()">
                                        <div class="action-buttons">
                                            ${(isAdmin || hasEditableFields) ? 
                                              `<button onclick="editItem(${originalIndex})" class="btn-primary">‚úèÔ∏è Edit</button>` : ''}
                                            ${isAdmin ? `<button onclick="deleteItem(${originalIndex})" class="btn-danger">üóëÔ∏è Delete</button>` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            elements.tableContainer.innerHTML = tableHTML;
        }

        // Item CRUD Operations
        function viewItem(index) {
            editingIndex = index;
            currentViewMode = 'view';
            showModal('View Item Details', jsonData[index], 'view');
        }

        function editItem(index) {
            editingIndex = index;
            currentViewMode = 'edit';
            showModal('Edit Item', jsonData[index], 'edit');
        }

        function deleteItem(index) {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this item?')) {
                jsonData.splice(index, 1);
                applySearchAndFilters();
                if (CONFIG.autoSave) saveToFile();
                showNotification('Item deleted');
            }
        }

        function addNewItem() {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            editingIndex = -1;
            currentViewMode = 'add';
            const template = jsonData.length > 0 ? 
                Object.fromEntries(Object.keys(jsonData[0]).map(key => [key, ''])) : 
                { id: '', name: '', value: '' };
            showModal('Add New Item', template, 'add');
        }

        function showModal(title, data, mode) {
            elements.modalTitle.textContent = title;
            isUserInteracting = true;
            
            if (mode === 'view') {
                elements.modalBody.innerHTML = `
                    <div class="view-mode">
                        <h3>Item Details</h3>
                        <div class="data-display">
                            ${Object.keys(data).map(key => `
                                <div class="data-item">
                                    <div class="data-label">${key}:</div>
                                    <div class="data-value">
                                        ${key === 'Status' ? formatStatus(data[key]) : makeLinksClickable(data[key] || '<em>No value</em>')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                elements.modalFooter.innerHTML = `
                    ${(isAdmin || CONFIG.editableByAll.some(field => field in data)) ? 
                      `<button onclick="editItem(${editingIndex})" class="btn-primary">‚úèÔ∏è Edit</button>` : ''}
                    <button onclick="closeModal()" class="btn-danger">Close</button>
                `;
            } else {
                elements.modalBody.innerHTML = `
                    <div class="form-grid">
                        ${Object.keys(data).map(key => {
                            if (['Edited_By', 'Last_Edit_Date', 'Created_By', 'Created_Date'].includes(key)) return '';
                            
                            const value = data[key] || '';
                            const isLongText = String(value).length > 100;
                            const isEditable = isAdmin || CONFIG.editableByAll.includes(key);
                            
                            if (isLongText) {
                                return `
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="modal-${key}">${key}</label>
                                        <textarea id="modal-${key}" ${!isEditable ? 'readonly' : ''}>${value}</textarea>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="form-group">
                                        <label for="modal-${key}">${key}</label>
                                        <input type="text" id="modal-${key}" 
                                               value="${String(value).replace(/"/g, '&quot;')}" 
                                               ${!isEditable ? 'readonly' : ''} />
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
                
                elements.modalFooter.innerHTML = `
                    <button onclick="saveModalData()" class="btn-success">üíæ Save</button>
                    <button onclick="closeModal()" class="btn-danger">Cancel</button>
                `;
            }
            
            elements.modal.style.display = 'block';
        }

        function closeModal() {
            elements.modal.style.display = 'none';
            isUserInteracting = false;
        }

        function saveModalData() {
            const inputs = elements.modal.querySelectorAll('input, textarea');
            const newData = {};
            
            // Check for unauthorized edits
            if (!isAdmin) {
                const originalItem = editingIndex >= 0 ? jsonData[editingIndex] : {};
                for (const input of inputs) {
                    const key = input.id.replace('modal-', '');
                    if (!CONFIG.editableByAll.includes(key) && 
                        String(input.value) !== String(originalItem[key])) {
                        showNotification('Only admins can edit these fields', 'error');
                        return;
                    }
                }
            }
            
            // Collect data
            inputs.forEach(input => {
                const key = input.id.replace('modal-', '');
                newData[key] = input.value;
            });
            
            // Add tracking metadata
            newData['Edited_By'] = currentUser;
            newData['Last_Edit_Date'] = new Date().toLocaleString();
            
            if (currentViewMode === 'add') {
                newData['Created_By'] = currentUser;
                newData['Created_Date'] = new Date().toLocaleString();
                jsonData.push(newData);
                showNotification(`Item added by ${currentUser}!`);
            } else {
                // Preserve creation info
                const originalItem = jsonData[editingIndex];
                if (originalItem['Created_By']) newData['Created_By'] = originalItem['Created_By'];
                if (originalItem['Created_Date']) newData['Created_Date'] = originalItem['Created_Date'];
                
                jsonData[editingIndex] = newData;
                showNotification(`Item updated by ${currentUser}!`);
            }
            
            applySearchAndFilters();
            closeModal();
            if (CONFIG.autoSave) saveToFile();
        }

        // Utility Functions
        function makeLinksClickable(text) {
            if (!text) return '';
            return String(text).replace(
                /(https?:\/\/[^\s<]+)|(www\.[^\s<]+)|(ftp:\/\/[^\s<]+)|([a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\/[^\s<]*)/g,
                match => `<a href="${match.match(/^https?:\/\//) ? match : 'http://' + match}" 
                           target="_blank" class="clickable-link" 
                           onclick="event.stopPropagation()">${match}</a>`
            );
        }

        function formatStatus(status) {
            if (!status) return '';
            const statusClass = CONFIG.statusColors[status] || '';
            return `<span class="status-badge ${statusClass}">${status}</span>`;
        }

        function exportData() {
            if (jsonData.length === 0) {
                showNotification('No data to export!', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(jsonData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportName = `sea_master_data_${new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19)}.json`;
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', exportName);
            link.click();
            
            showNotification('Data exported successfully!');
        }

        function showNotification(message, type = 'success') {
            elements.notification.textContent = message;
            elements.notification.style.background = 
                type === 'error' ? 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)' :
                type === 'info' ? 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)' :
                'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            
            elements.notification.style.transform = 'translateX(0)';
            setTimeout(() => elements.notification.style.transform = 'translateX(400px)', 3000);
        }

        // Storage Functions
        function saveFiltersToStorage() {
            localStorage.setItem('seaMasterFilters', JSON.stringify(activeFilters));
            localStorage.setItem('seaMasterSearch', currentSearchTerm);
        }

        function loadFiltersFromStorage() {
            const savedFilters = localStorage.getItem('seaMasterFilters');
            const savedSearch = localStorage.getItem('seaMasterSearch');
            
            if (savedFilters) activeFilters = JSON.parse(savedFilters);
            if (savedSearch) {
                currentSearchTerm = savedSearch;
                elements.searchInput.value = currentSearchTerm;
            }
            
            return savedFilters || savedSearch;
        }

        // File Handling
        elements.fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsedData = file.name.endsWith('.csv') ? parseCSV(e.target.result) : JSON.parse(e.target.result);
                    jsonData = Array.isArray(parsedData) ? parsedData : [parsedData];
                    
                    // Reset filters and search
                    activeFilters = {};
                    currentSearchTerm = '';
                    elements.searchInput.value = '';
                    filteredData = [...jsonData];
                    
                    initFilterPanel();
                    renderDashboard();
                    showNotification('File loaded successfully!');
                    
                    if (CONFIG.autoSave) saveToFile();
                } catch (error) {
                    showNotification('Error parsing file!', 'error');
                    console.error('File parse error:', error);
                }
            };
            
            reader.readAsText(file);
        });

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',');
                const obj = {};
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = values[j] ? values[j].trim() : '';
                }
                
                result.push(obj);
            }
            
            return result;
        }

        // Event Listeners
        elements.searchInput.addEventListener('input', function(e) {
            currentSearchTerm = e.target.value.toLowerCase();
            isUserInteracting = true;
            applySearchAndFilters();
            saveFiltersToStorage();
            setTimeout(() => isUserInteracting = false, 1000);
        });

        elements.searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') e.preventDefault();
        });

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoReload();
            } else {
                startAutoReload();
                loadDataFromPath();
            }
        });

        document.addEventListener('focusout', function(e) {
            if (e.target.matches('input, textarea, select')) {
                setTimeout(() => isUserInteracting = false, 500);
            }
        });

        document.addEventListener('focusin', function(e) {
            if (e.target.matches('input, textarea, select')) {
                isUserInteracting = true;
            }
        });

        window.onclick = function(event) {
            if (event.target === elements.modal) {
                closeModal();
            }
        };

        // Auto-reload Control
        function startAutoReload() {
            if (CONFIG.autoReload) {
                reloadInterval = setInterval(loadDataFromPath, CONFIG.reloadInterval);
            }
        }

        function stopAutoReload() {
            if (reloadInterval) clearInterval(reloadInterval);
        }

        // Initialization
        function initializeApp() {
            elements.dataSourceDisplay.textContent = CONFIG.dataPath;
            checkAdminStatus();
            getUserIdentifier();
            loadDataFromPath();
            startAutoReload();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
